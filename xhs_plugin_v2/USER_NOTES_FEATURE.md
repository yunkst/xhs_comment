# 小红书通知备注功能

## 功能概述

在小红书通知页面的每个通知旁边添加备注输入框，用户可以为每个通知添加个人备注，备注会自动保存到后端服务器。

## 功能特性

### 1. 自动备注输入框
- 在每个通知项的右侧自动添加备注文本框
- 文本框支持自动高度调整
- 输入时实时保存（防抖500ms）

### 2. 智能保存机制
- 失焦自动保存
- 输入变化时延迟保存
- 保存状态可视化反馈：
  - 🟡 保存中（黄色边框 + 脉冲动画）
  - 🟢 保存成功（绿色边框 + ✓ 图标）
  - 🔴 保存失败（红色边框 + ! 图标）

### 3. 数据持久化
- 备注数据保存到后端数据库
- 支持批量加载用户备注
- 页面刷新后备注内容自动恢复

### 4. 哈希匹配机制
- 使用通知哈希值作为唯一标识
- 格式：`{用户ID}_{内容摘要}_{通知类型}`
- 支持旧格式哈希值的兼容性迁移

## 技术实现

### 核心模块

1. **user-notes.js** - 用户备注核心模块
   - `addNoteInputToContainer()` - 添加备注输入框
   - `saveUserNote()` - 保存备注到后端
   - `generateNotificationHash()` - 生成通知哈希

2. **api-service.js** - API服务模块
   - `fetchUserNotes()` - 获取用户备注
   - `fetchUserNotesInBatch()` - 批量获取备注
   - `saveUserNote()` - 保存备注API调用

3. **notification-handler.js** - 通知处理模块
   - 集成备注功能到通知列表
   - 批量获取新用户备注数据

### 数据流程

```
用户输入备注 → 防抖延迟 → 生成哈希 → API保存 → 状态反馈
    ↓
页面加载 → 提取用户ID → 批量获取备注 → 填充输入框
```

## 使用方法

### 1. 安装插件
1. 加载 `xhs_plugin_v2` 插件到Chrome
2. 确保后端API服务正在运行
3. 在插件选项中配置API地址和认证令牌

### 2. 使用备注功能
1. 打开小红书通知页面：`https://www.xiaohongshu.com/notification`
2. 等待页面加载完成，插件会自动添加备注输入框
3. 在通知右侧的文本框中输入备注
4. 备注会自动保存，观察边框颜色变化确认保存状态

### 3. 备注管理
- 备注内容会自动保存到数据库
- 支持多行文本输入
- 文本框会根据内容自动调整高度
- 页面刷新后备注内容会自动恢复

## API接口

### 保存备注
```
POST /api/user-notes
{
  "userId": "用户ID",
  "notificationHash": "通知哈希值",
  "noteContent": "备注内容",
  "content": "通知内容"
}
```

### 获取用户备注
```
GET /api/user-notes?user_id={用户ID}
```

### 批量获取备注
```
GET /api/user-notes/batch?user_ids={用户ID1,用户ID2,...}
```

## 样式定制

插件会自动添加以下CSS样式：
- 备注输入框样式
- 保存状态动画
- 滚动条美化
- 悬停效果

## 故障排除

### 1. 备注输入框不显示
- 检查插件是否正确加载
- 确认在小红书通知页面
- 查看控制台是否有错误信息

### 2. 备注保存失败
- 检查API服务器是否运行
- 确认API地址和令牌配置正确
- 查看网络请求是否成功

### 3. 备注内容丢失
- 检查后端数据库连接
- 确认用户认证状态
- 查看API响应是否正常

## 开发说明

### 文件结构
```
xhs_plugin_v2/
├── injected/
│   ├── user-notes.js          # 用户备注模块
│   ├── api-service.js         # API服务模块
│   ├── notification-handler.js # 通知处理模块
│   └── index.js               # 主入口文件
├── manifest.json              # 插件配置
└── USER_NOTES_FEATURE.md      # 功能说明文档
```

### 调试方法
1. 打开Chrome开发者工具
2. 查看Console面板的日志输出
3. 搜索 `[User Notes]` 或 `[API Service]` 标签
4. 检查Network面板的API请求

### 扩展功能
- 支持备注分类标签
- 添加备注搜索功能
- 实现备注导出功能
- 支持备注模板功能

## 更新日志

### v2.1.0
- 新增通知备注功能
- 实现自动保存机制
- 添加状态可视化反馈
- 支持批量备注加载
- 兼容旧格式哈希值

---

**注意：** 此功能需要配合后端API服务使用，确保相关接口已正确实现。 