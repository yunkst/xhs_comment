# 小红书网络监控插件 SSO 登录使用指南

本指南将帮助您使用插件的单点登录(SSO)功能，无需在插件中直接输入账号密码即可登录API服务。

## 前提条件

1. 后端服务器已启用Keycloak SSO或其他兼容的SSO服务
2. 您已在SSO系统中注册了账号
3. 插件已正确配置API地址

## 使用步骤

### 1. 配置API地址

首先，您需要配置后端API地址：

1. 打开插件弹出窗口
2. 点击底部的"⚙️ 配置"链接
3. 在配置页面的"🌐 API服务器配置"部分填写API地址，如：`https://your-api-server.com`
4. 点击"🔗 测试连接"按钮验证连接
5. 点击"💾 保存API配置"按钮

### 2. 使用SSO登录

#### 步骤一：发起SSO登录

1. 返回插件弹出窗口，您将看到蓝色的"🔐 单点登录 (SSO)"按钮
2. 点击该按钮，插件将创建SSO会话并打开新标签页
3. 在新标签页中，您将进入SSO登录页面（如Keycloak）

#### 步骤二：在SSO系统中登录

1. 在SSO登录页面中输入您的账号和密码
2. 根据您的SSO配置，可能还需要提供二次验证码(OTP)
3. 点击"登录"按钮完成身份认证
4. 登录成功后，页面会显示"SSO登录成功"消息

#### 步骤三：完成授权

1. 返回插件弹出窗口
2. 点击绿色的"✅ 已完成登录，点击继续"按钮
3. 插件将检查您的登录状态，并获取访问令牌
4. 成功获取令牌后，您将看到"SSO登录成功！"提示

### 3. 验证登录状态

登录成功后：

1. 插件顶部的API状态会更新为"API已连接: xxx... (已登录)"
2. 配置页面中的登录状态会显示为"已登录"
3. 您的访问令牌已保存，可以用于后续的API调用

## 功能特性

### Token自动刷新

插件支持自动刷新访问令牌：

- 当API请求返回401错误时，插件会自动尝试刷新令牌
- 使用refresh token获取新的access token
- 无需用户重新登录

### 安全性

- 所有敏感信息（token）仅存储在浏览器本地
- 支持HTTPS加密传输
- 遵循OAuth 2.0标准安全实践

## 故障排除

### 1. 登录页面无法打开

**可能原因：**
- 网络连接问题
- API地址配置错误
- 后端服务未运行

**解决方案：**
- 检查网络连接
- 验证API地址是否正确
- 使用"测试连接"功能验证服务器状态

### 2. SSO登录成功，但插件显示"未完成登录"

**可能原因：**
- SSO会话已过期
- 浏览器阻止了跨域请求
- 后端SSO配置问题

**解决方案：**
- 点击"重新发起SSO登录"按钮重试
- 检查浏览器是否阻止了弹出窗口
- 联系管理员检查SSO配置

### 3. "已完成登录"按钮点击后出错

**可能原因：**
- SSO会话已过期
- 网络连接问题
- 后端服务异常

**解决方案：**
- 重新发起SSO登录
- 检查网络连接
- 查看浏览器控制台错误信息

### 4. "保存Token失败"错误

**可能原因：**
- 浏览器存储空间不足
- 浏览器设置阻止了数据存储

**解决方案：**
- 清理浏览器缓存和数据
- 检查浏览器隐私设置
- 重启浏览器后重试

## 注意事项

1. **会话有效期**：SSO登录会话通常有效期为10-30分钟，请尽快完成登录流程
2. **Token存储**：访问令牌存储在浏览器的插件存储空间中，卸载插件会清除所有数据
3. **多设备登录**：每个浏览器/设备需要单独进行SSO登录
4. **退出登录**：在配置页面点击"🚪 退出登录"按钮可以清除本地存储的登录凭据

## API接口说明

插件使用以下API接口：

- `POST /api/auth/sso-session` - 创建SSO会话
- `GET /api/auth/sso-session/{session_id}` - 检查SSO登录状态
- `POST /api/auth/sso-refresh` - 刷新访问令牌
- `GET /api/health` - 健康检查

## 技术支持

如果您在使用过程中遇到问题，请：

1. 查看浏览器控制台错误信息
2. 检查网络请求是否正常
3. 联系系统管理员获取帮助
4. 提供详细的错误信息和操作步骤

---

**版本信息**：v2.0  
**更新时间**：2024年12月  
**兼容性**：Chrome 88+, Edge 88+, Firefox 78+ 