# 评论互动关系调试指南

## 问题描述
- 后端日志显示上传了3条评论，但历史评论查询只返回1条
- 缺少评论互动关系的显示

## 调试步骤

### 1. 重启后端服务
```bash
cd xhs_backend
# 重启服务以应用调试接口
python main.py
```

### 2. 运行调试脚本
```bash
cd xhs_plugin_v2
node test_database_comments_debug.js
```

### 3. 分析调试结果

#### 3.1 历史评论查询结果
- 查看返回的评论数量
- 分析isTargetUser标记
- 检查回复关系字段

#### 3.2 笔记评论查询结果
- 验证数据库中实际存储的评论数量
- 检查评论的authorId字段
- 分析repliedId字段（回复关系）

#### 3.3 用户评论查询结果
- 查看用户自己的评论数量
- 查看回复给用户的评论数量
- 分析评论的关联关系

#### 3.4 最近评论记录
- 验证最新上传的评论数据
- 检查数据格式是否正确

## 可能的问题和解决方案

### 问题1：评论authorId不匹配
**症状**: 上传3条评论，但只有1条属于目标用户
**解决**: 检查小红书API数据结构，确认authorId字段正确提取

### 问题2：回复关系丢失
**症状**: repliedId字段为空或不正确
**解决**: 修复`_extract_comment_from_api_response`中的target_comment处理

### 问题3：查询逻辑不完整
**症状**: 数据库中有互动评论，但查询时没有包含
**解决**: 优化`get_user_historical_comments`的查询条件

### 问题4：数据结构不匹配
**症状**: 小红书API返回的数据结构与处理逻辑不匹配
**解决**: 根据实际API响应调整数据提取逻辑

## 预期结果
- 历史评论应包含完整的互动关系
- 显示用户的评论 + 回复给用户的评论 + 用户回复的原评论
- 每条评论的isTargetUser标记应正确

## 测试数据参考
- 用户ID: 5bd3275ddeb1fe0001332f23
- 笔记ID: 65eda5380000000012034011
- 应显示完整的评论互动上下文

## 下一步行动
1. 运行调试脚本获取详细数据
2. 根据实际返回数据分析问题
3. 针对性修复数据处理或查询逻辑
4. 验证修复效果 