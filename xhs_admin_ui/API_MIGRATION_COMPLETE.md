# ğŸ‰ APIæ¥å£è¿ç§»å®Œæˆ - ç™»å½•æ³¨å†ŒåŠŸèƒ½å¢å¼º

## ğŸ“‹ æœ¬æ¬¡æ›´æ–°å†…å®¹

**æ›´æ–°æ—¥æœŸï¼š** 2024-12-01  
**æ›´æ–°ç‰ˆæœ¬ï¼š** v2.2.0  
**ä¸»è¦åŠŸèƒ½ï¼š** åœ¨ç™»å½•é¡µé¢æ·»åŠ æ³¨å†ŒåŠŸèƒ½ï¼Œæ ¹æ®åç«¯ç¯å¢ƒå˜é‡æ§åˆ¶æ˜¾ç¤º

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. æ³¨å†ŒåŠŸèƒ½ âœ…
- âœ… **æ³¨å†Œæ ‡ç­¾é¡µ**ï¼šç™»å½•é¡µé¢æ–°å¢æ³¨å†Œæ ‡ç­¾é¡µ
- âœ… **æ³¨å†Œè¡¨å•**ï¼šç”¨æˆ·åã€å¯†ç ã€ç¡®è®¤å¯†ç è¾“å…¥
- âœ… **è¡¨å•éªŒè¯**ï¼šå®Œæ•´çš„å‰ç«¯è¡¨å•éªŒè¯è§„åˆ™
- âœ… **æ³¨å†Œæµç¨‹**ï¼šæ³¨å†Œ â†’ æ˜¾ç¤ºOTPäºŒç»´ç  â†’ å¼•å¯¼ç™»å½•

### 2. åŠ¨æ€æ˜¾ç¤ºæ§åˆ¶ âœ…
- âœ… **æ³¨å†ŒçŠ¶æ€æ£€æŸ¥**ï¼šé¡µé¢åŠ è½½æ—¶æ£€æŸ¥åç«¯æ³¨å†ŒçŠ¶æ€
- âœ… **æ¡ä»¶æ˜¾ç¤º**ï¼šæ ¹æ®`ALLOW_REGISTER`ç¯å¢ƒå˜é‡æ§åˆ¶æ³¨å†Œæ ‡ç­¾æ˜¾ç¤º
- âœ… **ä¼˜é›…é™çº§**ï¼šæ³¨å†Œå…³é—­æ—¶åªæ˜¾ç¤ºç™»å½•æ ‡ç­¾é¡µ

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ– âœ…
- âœ… **æ ‡ç­¾åˆ‡æ¢**ï¼šç™»å½•/æ³¨å†Œä¹‹é—´å¹³æ»‘åˆ‡æ¢
- âœ… **è¡¨å•è”åŠ¨**ï¼šæ³¨å†ŒæˆåŠŸåè‡ªåŠ¨å°†ç”¨æˆ·åå¤åˆ¶åˆ°ç™»å½•è¡¨å•
- âœ… **å¼•å¯¼æµç¨‹**ï¼šæ¸…æ™°çš„æ³¨å†Œâ†’OTPè®¾ç½®â†’ç™»å½•æµç¨‹æŒ‡å¼•
- âœ… **é”™è¯¯å¤„ç†**ï¼šè¯¦ç»†çš„é”™è¯¯æç¤ºå’ŒçŠ¶æ€åé¦ˆ

## ğŸ”§ APIæ¥å£å®Œæ•´è¿ç§»

### å‰ç«¯æ¥å£ (api.js)
```javascript
// ç”¨æˆ·è®¤è¯æ¥å£ - å®Œå…¨è¿ç§»åˆ°æ–°æ¶æ„
export const userApi = {
  login: (data) => api.post('/api/v1/user/auth/login', data),
  register: (data) => api.post('/api/v1/user/auth/register', data),
  getOtpQrcode: (username) => api.get(`/api/v1/user/auth/otp-qrcode?username=${username}`),
  checkRegisterStatus: () => api.get('/api/v1/user/auth/register-status')
}

// SSOè®¤è¯æ¥å£ - å®Œå…¨è¿ç§»åˆ°æ–°æ¶æ„
export const ssoApi = {
  getSsoLoginUrl: () => api.get('/api/v1/user/auth/sso-login-url'),
  refreshSsoToken: (refreshToken) => api.post('/api/v1/user/auth/sso-refresh', { refresh_token: refreshToken }),
  getSsoUserInfo: () => api.get('/api/v1/user/auth/sso-userinfo')
}
```

### åç«¯æ¥å£ (auth.py)
```python
# æ–°å¢æ¥å£
@router.get("/register-status")  # æ£€æŸ¥æ³¨å†ŒçŠ¶æ€
@router.post("/register")        # ç”¨æˆ·æ³¨å†Œ (v1æ¶æ„)
@router.post("/login")           # ç”¨æˆ·ç™»å½• (v1æ¶æ„) 
@router.get("/otp-qrcode")       # OTPäºŒç»´ç  (è¿”å›base64)
@router.get("/me")               # å½“å‰ç”¨æˆ·ä¿¡æ¯
```

## ğŸ¨ å‰ç«¯UIæ”¹è¿›

### ç™»å½•é¡µé¢ (LoginView.vue)
```vue
<!-- æ–°çš„æ ‡ç­¾é¡µç»“æ„ -->
<el-tabs v-model="activeTab" @tab-change="handleTabChange">
  <el-tab-pane label="ç™»å½•" name="login">
    <!-- åŸæœ‰ç™»å½•è¡¨å• -->
  </el-tab-pane>
  
  <el-tab-pane label="æ³¨å†Œ" name="register" v-if="allowRegister">
    <!-- æ–°çš„æ³¨å†Œè¡¨å• -->
  </el-tab-pane>
</el-tabs>

<!-- å¢å¼ºçš„OTPå¯¹è¯æ¡† -->
<el-dialog v-model="qrcodeDialogVisible" title="OTPè®¾ç½®">
  <!-- äºŒç»´ç æ˜¾ç¤º + å®ŒæˆæŒ‰é’® -->
</el-dialog>
```

### æ–°å¢åŠŸèƒ½å‡½æ•°
```javascript
âœ… handleRegister()        // æ³¨å†Œå¤„ç†
âœ… checkRegisterStatus()   // æ£€æŸ¥æ³¨å†ŒçŠ¶æ€
âœ… handleQrcodeComplete()  // OTPè®¾ç½®å®Œæˆ
âœ… loadOtpQrcodeForUser()  // åŠ è½½æŒ‡å®šç”¨æˆ·OTP
âœ… handleTabChange()       // æ ‡ç­¾åˆ‡æ¢å¤„ç†
```

## ğŸš€ æŠ€æœ¯ç‰¹æ€§

### 1. å“åº”å¼è®¾è®¡
- è‡ªé€‚åº”å¸ƒå±€ï¼Œæ”¯æŒä¸åŒå±å¹•å°ºå¯¸
- ä¼˜é›…çš„æ ‡ç­¾é¡µåˆ‡æ¢åŠ¨ç”»
- ç»Ÿä¸€çš„è§†è§‰é£æ ¼

### 2. è¡¨å•éªŒè¯
```javascript
// å¯†ç ç¡®è®¤éªŒè¯
validator: (rule, value, callback) => {
  if (value !== registerForm.password) {
    callback(new Error('ä¸¤æ¬¡è¾“å…¥å¯†ç ä¸ä¸€è‡´'))
  } else {
    callback()
  }
}
```

### 3. ç¯å¢ƒå˜é‡æ§åˆ¶
```bash
# åç«¯ç¯å¢ƒå˜é‡
ALLOW_REGISTER=true   # å¼€å¯æ³¨å†ŒåŠŸèƒ½
ALLOW_REGISTER=false  # å…³é—­æ³¨å†ŒåŠŸèƒ½
```

### 4. é”™è¯¯å¤„ç†ç­–ç•¥
```javascript
// åˆ†ç±»é”™è¯¯å¤„ç†
if (error.response?.status === 400) {
  ElMessage.error('ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·æ›´æ¢ç”¨æˆ·å')
} else if (error.response?.status === 403) {
  ElMessage.error('æ³¨å†ŒåŠŸèƒ½å·²å…³é—­')
} else {
  ElMessage.error('æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•')
}
```

## ğŸ“Š æ¥å£è¿ç§»å®Œæˆåº¦

| æ¨¡å— | è¿ç§»å‰çŠ¶æ€ | è¿ç§»åçŠ¶æ€ | çŠ¶æ€ |
|------|------------|------------|------|
| ç”¨æˆ·ç™»å½• | `/api/login` | `/api/v1/user/auth/login` | âœ… å®Œæˆ |
| ç”¨æˆ·æ³¨å†Œ | `/api/register` | `/api/v1/user/auth/register` | âœ… å®Œæˆ |
| OTPäºŒç»´ç  | `/api/otp-qrcode` | `/api/v1/user/auth/otp-qrcode` | âœ… å®Œæˆ |
| SSOç™»å½• | `/api/auth/sso-*` | `/api/v1/user/auth/sso-*` | âœ… å®Œæˆ |
| æ³¨å†ŒçŠ¶æ€ | âŒ æ—  | `/api/v1/user/auth/register-status` | âœ… æ–°å¢ |

**æ€»ä½“å®Œæˆåº¦ï¼š** 100% (å®Œå…¨è¿ç§»åˆ°æ–°çš„é¢†åŸŸé©±åŠ¨æ¶æ„)

## ğŸ¯ ä½¿ç”¨è¯´æ˜

### ç®¡ç†å‘˜é…ç½®
```bash
# å¼€å¯æ³¨å†ŒåŠŸèƒ½
export ALLOW_REGISTER=true

# å…³é—­æ³¨å†ŒåŠŸèƒ½
export ALLOW_REGISTER=false
```

### ç”¨æˆ·æ“ä½œæµç¨‹
1. **æ³¨å†Œæµç¨‹** (å½“æ³¨å†Œå¼€å¯æ—¶)ï¼š
   - è®¿é—®ç™»å½•é¡µé¢
   - ç‚¹å‡»"æ³¨å†Œ"æ ‡ç­¾é¡µ
   - å¡«å†™ç”¨æˆ·åå’Œå¯†ç 
   - ç‚¹å‡»"æ³¨å†Œ"æŒ‰é’®
   - æ‰«æOTPäºŒç»´ç è®¾ç½®åŠ¨æ€éªŒè¯ç 
   - ç‚¹å‡»"è®¾ç½®å®Œæˆ"è¿”å›ç™»å½•é¡µé¢
   - ä½¿ç”¨ç”¨æˆ·åã€å¯†ç å’ŒåŠ¨æ€éªŒè¯ç ç™»å½•

2. **ç™»å½•æµç¨‹**ï¼š
   - è¾“å…¥ç”¨æˆ·åã€å¯†ç ã€åŠ¨æ€éªŒè¯ç 
   - ç‚¹å‡»"ç™»å½•"æŒ‰é’®
   - æˆ–ä½¿ç”¨"å•ç‚¹ç™»å½•(SSO)"

### å¼€å‘è€…æµ‹è¯•
```javascript
// æµ‹è¯•æ³¨å†ŒçŠ¶æ€æ£€æŸ¥
const status = await userApi.checkRegisterStatus()
console.log('æ³¨å†ŒçŠ¶æ€:', status.allow_register)

// æµ‹è¯•æ³¨å†ŒåŠŸèƒ½
const result = await userApi.register({
  username: 'testuser',
  password: 'password123'
})
console.log('æ³¨å†Œç»“æœ:', result)
```

## ğŸ”„ å‘åå…¼å®¹æ€§

- âœ… **å®Œå…¨å‘åå…¼å®¹**ï¼šåŸæœ‰APIè·¯å¾„é€šè¿‡é‡å®šå‘ç»§ç»­å·¥ä½œ
- âœ… **æ¸è¿›å¼è¿ç§»**ï¼šæ–°åŠŸèƒ½ä½¿ç”¨æ–°æ¶æ„ï¼Œæ—§åŠŸèƒ½å¹³æ»‘è¿‡æ¸¡
- âœ… **æ–‡æ¡£å®Œæ•´**ï¼šè¯¦ç»†çš„è¿ç§»æŒ‡å—å’Œä½¿ç”¨è¯´æ˜

## ğŸŠ æ€»ç»“

æœ¬æ¬¡æ›´æ–°æˆåŠŸå®ç°äº†ï¼š

1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€OTPè®¾ç½®çš„å®Œæ•´æµç¨‹
2. **æ¶æ„ä¸€è‡´æ€§**ï¼šæ‰€æœ‰ç”¨æˆ·è®¤è¯æ¥å£è¿ç§»åˆ°æ–°çš„é¢†åŸŸé©±åŠ¨æ¶æ„
3. **ç”¨æˆ·ä½“éªŒ**ï¼šä¼˜é›…çš„UIè®¾è®¡å’Œæµç•…çš„æ“ä½œæµç¨‹
4. **çµæ´»é…ç½®**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡çµæ´»æ§åˆ¶æ³¨å†ŒåŠŸèƒ½
5. **é”™è¯¯å‹å¥½**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

ç™»å½•é¡µé¢ç°åœ¨å…·å¤‡äº†å®Œæ•´çš„ç”¨æˆ·ç®¡ç†åŠŸèƒ½ï¼Œæ—¢æ”¯æŒæ–°ç”¨æˆ·æ³¨å†Œï¼Œä¹Ÿä¿æŒäº†åŸæœ‰ç™»å½•åŠŸèƒ½çš„ç¨³å®šæ€§ã€‚é€šè¿‡ç¯å¢ƒå˜é‡å¯ä»¥çµæ´»æ§åˆ¶æ˜¯å¦å¼€æ”¾æ³¨å†Œï¼Œæ»¡è¶³ä¸åŒéƒ¨ç½²ç¯å¢ƒçš„éœ€æ±‚ã€‚

---

**å¼€å‘å·¥ç¨‹å¸ˆï¼š** Claude AI Assistant  
**å®Œæˆæ—¶é—´ï¼š** 2024-12-01  
**ä¸‹æ¬¡è®¡åˆ’ï¼š** ä¼˜åŒ–ç”¨æˆ·èµ„æ–™ç®¡ç†å’Œæƒé™ç³»ç»Ÿ 