import{_ as pe,a as w,r as P,o as _e,c as U,b as t,w as a,D as $,E as x,e as r,F as O,f as fe,g as C,i as o,u as b,G as ve,t as _,q as me,H as ye,B as ge,j as he,I as we,J as be,k as q,h as c,y as Ne,z as ke,l as G,K as Ve,A as J,C as Ce,m as Ie}from"./index-D0Zmay6M.js";const ze={class:"notification-view"},Se={class:"stats-content"},De={class:"stats-icon notifications"},Ue={class:"stats-info"},xe={class:"stats-value"},Te={class:"stats-content"},Be={class:"stats-icon today"},Pe={class:"stats-info"},$e={class:"stats-value"},Me={class:"stats-content"},Ye={class:"stats-icon types"},Ee={class:"stats-info"},He={class:"stats-value"},je={class:"stats-content"},Ke={class:"stats-icon users"},Ae={class:"stats-info"},Le={class:"stats-value"},Re={class:"card-header"},Fe={class:"header-actions"},Oe={class:"notification-content"},qe={class:"note-input-container"},Ge={key:0,class:"note-actions"},Je={class:"pagination-container"},Qe={key:0,class:"notification-detail"},We={class:"note-actions",style:{"margin-top":"10px"}},Xe={__name:"NotificationView",setup(Ze){const I=w(!1),m=w([]),M=w([]),T=w({}),B=w(!1),d=w(null),f=P({totalNotifications:0,todayNotifications:0,notificationTypes:0,activeUsers:0}),p=P({userId:"",type:"",keyword:""}),y=w([]),u=P({currentPage:1,pageSize:20,total:0}),Y=s=>{if(!s)return"未知时间";try{return new Date(s).toLocaleString("zh-CN")}catch{return"时间格式错误"}},E=s=>({评论:"primary",点赞:"success",关注:"warning","@":"info"})[s]||"default",H=s=>{if(!s||!s.userId)return"";const e=s.userId||"",i=(s.content||s.title||"").substring(0,20).replace(/\s+/g,""),n=s.type||"";return`${e}_${i}_${n}`},N=async()=>{I.value=!0;try{const s={page:u.currentPage,page_size:u.pageSize};p.userId&&(s.userId=p.userId),p.type&&(s.type=p.type),p.keyword&&(s.keyword=p.keyword),y.value&&y.value.length===2&&(s.startDate=y.value[0],s.endDate=y.value[1]);const e=await $.getNotificationList(s);e.success?(m.value=e.data||[],u.total=e.total||0,await A()):e.items?(m.value=e.items||[],u.total=e.total||0,await A()):(m.value=[],u.total=0)}catch(s){console.error("获取通知列表失败:",s),x.error("获取通知列表失败: "+s.message),m.value=[],u.total=0}finally{I.value=!1}},j=async()=>{var s,e,i;try{const n=await $.getNotificationsStats();n.success&&n.stats&&(f.totalNotifications=((s=n.stats.total)==null?void 0:s.notifications)||0,f.todayNotifications=((e=n.stats.period)==null?void 0:e.today)||0,f.notificationTypes=Object.keys(n.stats.by_type||{}).length,f.activeUsers=((i=n.stats.top_users)==null?void 0:i.length)||0)}catch(n){console.error("获取通知统计失败:",n)}},K=async()=>{try{const s=await $.getNotificationTypes();s.success&&(M.value=s.types||[])}catch(s){console.error("获取通知类型失败:",s)}},A=async()=>{try{const s=[...new Set(m.value.map(i=>i.userId).filter(Boolean))];if(s.length===0)return;const e=await O.getUserNotesBatch(s);e.success&&e.data&&(T.value=e.data,m.value.forEach(i=>{const n=H(i);i.userNote=T.value[n]||"",i.noteSaving=!1}))}catch(s){console.error("初始化用户备注失败:",s)}},k=async s=>{if(!s||!s.userId){x.warning("无效的通知数据");return}const e=H(s),i=s.userNote||"";s.noteSaving=!0;try{const n=await O.addUserNote({userId:s.userId,notificationHash:e,noteContent:i,content:s.content||s.title||""});if(n.success)T.value[e]=i,x.success("备注保存成功");else throw new Error(n.message||"保存失败")}catch(n){console.error("保存备注失败:",n),x.error("保存备注失败: "+n.message)}finally{s.noteSaving=!1}},L=async s=>{try{await Ie.confirm("确定要清除这条备注吗？","确认清除",{type:"warning"}),s.userNote="",await k(s)}catch{}},Q=()=>{u.currentPage=1,N()},W=()=>{Object.assign(p,{userId:"",type:"",keyword:""}),y.value=[],u.currentPage=1,N()},X=s=>{u.pageSize=s,u.currentPage=1,N()},Z=s=>{u.currentPage=s,N()},R=s=>{d.value={...s},B.value=!0},ee=s=>{d.value=null,s()},te=()=>{N(),j(),K()};return _e(()=>{N(),j(),K()}),(s,e)=>{const i=r("el-icon"),n=r("el-card"),S=r("el-col"),se=r("el-row"),v=r("el-button"),D=r("el-input"),z=r("el-form-item"),ae=r("el-option"),le=r("el-select"),oe=r("el-date-picker"),ne=r("el-form"),g=r("el-table-column"),F=r("el-tag"),ie=r("el-table"),re=r("el-pagination"),h=r("el-descriptions-item"),de=r("el-descriptions"),ue=r("el-dialog"),ce=fe("loading");return C(),U("div",ze,[t(se,{gutter:20,class:"stats-row"},{default:a(()=>[t(S,{span:6},{default:a(()=>[t(n,{class:"stats-card"},{default:a(()=>[o("div",Se,[o("div",De,[t(i,null,{default:a(()=>[t(b(ve))]),_:1})]),o("div",Ue,[e[11]||(e[11]=o("div",{class:"stats-title"},"总通知数",-1)),o("div",xe,_(f.totalNotifications||0),1)])])]),_:1})]),_:1}),t(S,{span:6},{default:a(()=>[t(n,{class:"stats-card"},{default:a(()=>[o("div",Te,[o("div",Be,[t(i,null,{default:a(()=>[t(b(me))]),_:1})]),o("div",Pe,[e[12]||(e[12]=o("div",{class:"stats-title"},"今日新增",-1)),o("div",$e,_(f.todayNotifications||0),1)])])]),_:1})]),_:1}),t(S,{span:6},{default:a(()=>[t(n,{class:"stats-card"},{default:a(()=>[o("div",Me,[o("div",Ye,[t(i,null,{default:a(()=>[t(b(ye))]),_:1})]),o("div",Ee,[e[13]||(e[13]=o("div",{class:"stats-title"},"通知类型",-1)),o("div",He,_(f.notificationTypes||0),1)])])]),_:1})]),_:1}),t(S,{span:6},{default:a(()=>[t(n,{class:"stats-card"},{default:a(()=>[o("div",je,[o("div",Ke,[t(i,null,{default:a(()=>[t(b(ge))]),_:1})]),o("div",Ae,[e[14]||(e[14]=o("div",{class:"stats-title"},"活跃用户",-1)),o("div",Le,_(f.activeUsers||0),1)])])]),_:1})]),_:1})]),_:1}),t(n,{class:"main-card"},{header:a(()=>[o("div",Re,[e[16]||(e[16]=o("span",null,"小红书通知管理",-1)),o("div",Fe,[t(v,{type:"primary",onClick:te,loading:I.value},{default:a(()=>[t(i,null,{default:a(()=>[t(b(Ce))]),_:1}),e[15]||(e[15]=c(" 刷新 "))]),_:1,__:[15]},8,["loading"])])])]),default:a(()=>[t(ne,{inline:!0,model:p,class:"search-form"},{default:a(()=>[t(z,{label:"用户ID"},{default:a(()=>[t(D,{modelValue:p.userId,"onUpdate:modelValue":e[0]||(e[0]=l=>p.userId=l),placeholder:"输入用户ID",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),t(z,{label:"通知类型"},{default:a(()=>[t(le,{modelValue:p.type,"onUpdate:modelValue":e[1]||(e[1]=l=>p.type=l),placeholder:"选择通知类型",clearable:"",style:{width:"150px"}},{default:a(()=>[(C(!0),U(we,null,be(M.value,l=>(C(),q(ae,{key:l.type,label:l.type,value:l.type},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(z,{label:"关键词"},{default:a(()=>[t(D,{modelValue:p.keyword,"onUpdate:modelValue":e[2]||(e[2]=l=>p.keyword=l),placeholder:"通知内容关键词",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),t(z,{label:"日期范围"},{default:a(()=>[t(oe,{modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=l=>y.value=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),t(z,null,{default:a(()=>[t(v,{type:"primary",onClick:Q,loading:I.value},{default:a(()=>[t(i,null,{default:a(()=>[t(b(Ne))]),_:1}),e[17]||(e[17]=c(" 查询 "))]),_:1,__:[17]},8,["loading"]),t(v,{onClick:W},{default:a(()=>[t(i,null,{default:a(()=>[t(b(ke))]),_:1}),e[18]||(e[18]=c(" 重置 "))]),_:1,__:[18]})]),_:1})]),_:1},8,["model"]),he((C(),q(ie,{data:m.value,stripe:"",style:{width:"100%"},"row-key":"_id",onRowClick:R},{default:a(()=>[t(g,{prop:"userId",label:"用户ID",width:"180","show-overflow-tooltip":""}),t(g,{prop:"type",label:"通知类型",width:"120"},{default:a(({row:l})=>[t(F,{type:E(l.type)},{default:a(()=>[c(_(l.type||"未知"),1)]),_:2},1032,["type"])]),_:1}),t(g,{prop:"content",label:"通知内容","min-width":"200","show-overflow-tooltip":""},{default:a(({row:l})=>[o("div",Oe,_(l.content||l.title||"无内容"),1)]),_:1}),t(g,{prop:"username",label:"用户名",width:"120","show-overflow-tooltip":""}),t(g,{label:"备注",width:"250"},{default:a(({row:l})=>[o("div",qe,[t(D,{modelValue:l.userNote,"onUpdate:modelValue":V=>l.userNote=V,type:"textarea",rows:2,placeholder:"添加备注...",class:"note-input",onBlur:V=>k(l),onKeydown:Ve(J(V=>k(l),["ctrl"]),["enter"]),size:"small"},null,8,["modelValue","onUpdate:modelValue","onBlur","onKeydown"]),l.userNote&&l.userNote.trim()?(C(),U("div",Ge,[t(v,{type:"success",size:"small",onClick:V=>k(l),loading:l.noteSaving},{default:a(()=>e[19]||(e[19]=[c(" 保存 ")])),_:2,__:[19]},1032,["onClick","loading"]),t(v,{type:"danger",size:"small",onClick:V=>L(l)},{default:a(()=>e[20]||(e[20]=[c(" 清除 ")])),_:2,__:[20]},1032,["onClick"])])):G("",!0)])]),_:1}),t(g,{prop:"timestamp",label:"时间",width:"160"},{default:a(({row:l})=>[c(_(Y(l.timestamp)),1)]),_:1}),t(g,{label:"操作",width:"100",fixed:"right"},{default:a(({row:l})=>[t(v,{type:"primary",size:"small",onClick:J(V=>R(l),["stop"])},{default:a(()=>e[21]||(e[21]=[c(" 详情 ")])),_:2,__:[21]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[ce,I.value]]),o("div",Je,[t(re,{"current-page":u.currentPage,"onUpdate:currentPage":e[4]||(e[4]=l=>u.currentPage=l),"page-size":u.pageSize,"onUpdate:pageSize":e[5]||(e[5]=l=>u.pageSize=l),"page-sizes":[10,20,50,100],total:u.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:X,onCurrentChange:Z},null,8,["current-page","page-size","total"])])]),_:1}),t(ue,{modelValue:B.value,"onUpdate:modelValue":e[10]||(e[10]=l=>B.value=l),title:"通知详情",width:"60%","before-close":ee},{default:a(()=>[d.value?(C(),U("div",Qe,[t(de,{column:2,border:""},{default:a(()=>[t(h,{label:"通知ID",span:2},{default:a(()=>[c(_(d.value._id),1)]),_:1}),t(h,{label:"用户ID"},{default:a(()=>[c(_(d.value.userId||"未知"),1)]),_:1}),t(h,{label:"用户名"},{default:a(()=>[c(_(d.value.username||"未知"),1)]),_:1}),t(h,{label:"通知类型"},{default:a(()=>[t(F,{type:E(d.value.type)},{default:a(()=>[c(_(d.value.type||"未知"),1)]),_:1},8,["type"])]),_:1}),t(h,{label:"时间"},{default:a(()=>[c(_(Y(d.value.timestamp)),1)]),_:1}),t(h,{label:"通知内容",span:2},{default:a(()=>[c(_(d.value.content||d.value.title||"无内容"),1)]),_:1}),t(h,{label:"用户备注",span:2},{default:a(()=>[t(D,{modelValue:d.value.userNote,"onUpdate:modelValue":e[6]||(e[6]=l=>d.value.userNote=l),type:"textarea",rows:3,placeholder:"添加或编辑备注...",onBlur:e[7]||(e[7]=l=>k(d.value))},null,8,["modelValue"]),o("div",We,[t(v,{type:"success",size:"small",onClick:e[8]||(e[8]=l=>k(d.value)),loading:d.value.noteSaving},{default:a(()=>e[22]||(e[22]=[c(" 保存备注 ")])),_:1,__:[22]},8,["loading"]),t(v,{type:"danger",size:"small",onClick:e[9]||(e[9]=l=>L(d.value))},{default:a(()=>e[23]||(e[23]=[c(" 清除备注 ")])),_:1,__:[23]})])]),_:1})]),_:1})])):G("",!0)]),_:1},8,["modelValue"])])}}},tt=pe(Xe,[["__scopeId","data-v-588a6ab9"]]);export{tt as default};
